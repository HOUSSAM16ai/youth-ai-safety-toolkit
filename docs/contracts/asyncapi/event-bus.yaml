asyncapi: 3.1.0
info:
  title: CogniForge Event Bus
  version: '1.0.0'
  description: |
    # ناقل الأحداث المركزي
    
    يوفر آلية نشر/اشتراك للتواصل غير المتزامن بين الخدمات المصغرة.
    
    ## المبادئ
    - **Loose Coupling**: الخدمات لا تعرف بعضها مباشرة
    - **Async Communication**: معالجة غير متزامنة
    - **Event Sourcing**: سجل كامل للأحداث
    - **Reliability**: ضمان توصيل الأحداث
  contact:
    name: CogniForge Support
    email: support@cogniforge.ai
    url: https://cogniforge.ai/support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  tags:
    - name: event-bus
      description: Core event bus operations

servers:
  production:
    host: rabbitmq.cogniforge.local:5672/v1
    protocol: amqp
    description: Production RabbitMQ Server

channels:
  user/created:
    description: حدث إنشاء مستخدم جديد
    messages:
      onUserCreated:
        $ref: '#/components/messages/UserCreated'
  
  user/updated:
    description: حدث تحديث بيانات مستخدم
    messages:
      onUserUpdated:
        $ref: '#/components/messages/UserUpdated'
  
  plan/created:
    description: حدث إنشاء خطة تعليمية جديدة
    messages:
      onPlanCreated:
        $ref: '#/components/messages/PlanCreated'
  
  plan/completed:
    description: حدث إكمال خطة تعليمية
    messages:
      onPlanCompleted:
        $ref: '#/components/messages/PlanCompleted'
  
  memory/stored:
    description: حدث حفظ ذاكرة جديدة
    messages:
      onMemoryStored:
        $ref: '#/components/messages/MemoryStored'
  
  learning/progress:
    description: حدث تقدم في التعلم
    messages:
      onLearningProgress:
        $ref: '#/components/messages/LearningProgress'
  
  task/assigned:
    description: حدث تعيين مهمة
    messages:
      onTaskAssigned:
        $ref: '#/components/messages/TaskAssigned'
  
  task/completed:
    description: حدث إكمال مهمة
    messages:
      onTaskCompleted:
        $ref: '#/components/messages/TaskCompleted'

components:
  securitySchemes:
    userPassword:
      type: userPassword
      description: Simple username/password authentication

  messages:
    UserCreated:
      name: UserCreated
      title: حدث إنشاء مستخدم
      summary: يُنشر عند إنشاء مستخدم جديد
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserCreatedPayload'
    
    UserUpdated:
      name: UserUpdated
      title: حدث تحديث مستخدم
      summary: يُنشر عند تحديث بيانات مستخدم
      contentType: application/json
      payload:
        $ref: '#/components/schemas/UserUpdatedPayload'
    
    PlanCreated:
      name: PlanCreated
      title: حدث إنشاء خطة
      summary: يُنشر عند إنشاء خطة تعليمية جديدة
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PlanCreatedPayload'
    
    PlanCompleted:
      name: PlanCompleted
      title: حدث إكمال خطة
      summary: يُنشر عند إكمال خطة تعليمية
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PlanCompletedPayload'
    
    MemoryStored:
      name: MemoryStored
      title: حدث حفظ ذاكرة
      summary: يُنشر عند حفظ ذاكرة جديدة
      contentType: application/json
      payload:
        $ref: '#/components/schemas/MemoryStoredPayload'
    
    LearningProgress:
      name: LearningProgress
      title: حدث تقدم في التعلم
      summary: يُنشر عند تحديث تقدم المتعلم
      contentType: application/json
      payload:
        $ref: '#/components/schemas/LearningProgressPayload'
    
    TaskAssigned:
      name: TaskAssigned
      title: حدث تعيين مهمة
      summary: يُنشر عند تعيين مهمة لوكيل
      contentType: application/json
      payload:
        $ref: '#/components/schemas/TaskAssignedPayload'
    
    TaskCompleted:
      name: TaskCompleted
      title: حدث إكمال مهمة
      summary: يُنشر عند إكمال مهمة
      contentType: application/json
      payload:
        $ref: '#/components/schemas/TaskCompletedPayload'

  schemas:
    EventBase:
      type: object
      required:
        - event_id
        - event_type
        - occurred_at
        - source
        - event_version
      properties:
        event_id:
          type: string
          format: uuid
          description: معرف فريد للحدث
        event_type:
          type: string
          description: نوع الحدث
        occurred_at:
          type: string
          format: date-time
          description: وقت وقوع الحدث
        timestamp:
          type: string
          format: date-time
          description: وقت معالجة الحدث (للتوافق القديم)
        source:
          type: string
          description: مصدر الحدث
        event_version:
          type: string
          description: إصدار هيكل الحدث
          example: "1.0.0"
        correlation_id:
          type: string
          format: uuid
          description: معرف الارتباط للتتبع
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440000"
        event_type: "user.created"
        occurred_at: "2024-01-01T12:00:00Z"
        source: "user-service"
        event_version: "1.0.0"
    
    UserCreatedPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - user_id
            - email
          properties:
            user_id:
              type: string
              format: uuid
            name:
              type: string
            email:
              type: string
              format: email
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440000"
        event_type: "user.created"
        occurred_at: "2024-01-01T12:00:00Z"
        source: "user-service"
        event_version: "1.0.0"
        user_id: "123e4567-e89b-12d3-a456-426614174000"
        name: "John Doe"
        email: "john@example.com"
    
    UserUpdatedPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - user_id
          properties:
            user_id:
              type: string
              format: uuid
            updated_fields:
              type: array
              items:
                type: string
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440001"
        event_type: "user.updated"
        occurred_at: "2024-01-01T12:30:00Z"
        source: "user-service"
        event_version: "1.0.0"
        user_id: "123e4567-e89b-12d3-a456-426614174000"
        updated_fields: ["email", "name"]
    
    PlanCreatedPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - plan_id
            - goal
          properties:
            plan_id:
              type: string
              format: uuid
            goal:
              type: string
            user_id:
              type: string
              format: uuid
            steps:
              type: array
              items:
                type: string
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440002"
        event_type: "plan.created"
        occurred_at: "2024-01-01T13:00:00Z"
        source: "planning-service"
        event_version: "1.0.0"
        plan_id: "123e4567-e89b-12d3-a456-426614174001"
        goal: "Learn Python"
        user_id: "123e4567-e89b-12d3-a456-426614174000"
        steps: ["Install Python", "Write Hello World"]
    
    PlanCompletedPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - plan_id
            - user_id
          properties:
            plan_id:
              type: string
              format: uuid
            user_id:
              type: string
              format: uuid
            completion_date:
              type: string
              format: date-time
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440003"
        event_type: "plan.completed"
        occurred_at: "2024-01-01T14:00:00Z"
        source: "planning-service"
        event_version: "1.0.0"
        plan_id: "123e4567-e89b-12d3-a456-426614174001"
        user_id: "123e4567-e89b-12d3-a456-426614174000"
        completion_date: "2024-01-01T14:00:00Z"
    
    MemoryStoredPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - memory_id
            - content
          properties:
            memory_id:
              type: string
              format: uuid
            content:
              type: string
            tags:
              type: array
              items:
                type: string
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440004"
        event_type: "memory.stored"
        occurred_at: "2024-01-01T15:00:00Z"
        source: "memory-service"
        event_version: "1.0.0"
        memory_id: "123e4567-e89b-12d3-a456-426614174002"
        content: "User prefers dark mode"
        tags: ["preference", "ui"]
    
    LearningProgressPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - user_id
            - plan_id
            - progress_percentage
          properties:
            user_id:
              type: string
              format: uuid
            plan_id:
              type: string
              format: uuid
            progress_percentage:
              type: number
              format: float
              minimum: 0
              maximum: 100
            current_step:
              type: integer
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440005"
        event_type: "learning.progress"
        occurred_at: "2024-01-01T16:00:00Z"
        source: "learning-service"
        event_version: "1.0.0"
        user_id: "123e4567-e89b-12d3-a456-426614174000"
        plan_id: "123e4567-e89b-12d3-a456-426614174001"
        progress_percentage: 50.0
        current_step: 1
    
    TaskAssignedPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - task_id
            - agent_name
          properties:
            task_id:
              type: string
              format: uuid
            agent_name:
              type: string
            description:
              type: string
            priority:
              type: string
              enum: [low, medium, high, critical]
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440006"
        event_type: "task.assigned"
        occurred_at: "2024-01-01T17:00:00Z"
        source: "task-service"
        event_version: "1.0.0"
        task_id: "123e4567-e89b-12d3-a456-426614174003"
        agent_name: "ResearchAgent"
        description: "Analyze market trends"
        priority: "high"
    
    TaskCompletedPayload:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          required:
            - task_id
            - agent_name
          properties:
            task_id:
              type: string
              format: uuid
            agent_name:
              type: string
            result:
              type: object
            completion_time:
              type: string
              format: date-time
            event_id:
              type: string
              format: uuid
            event_version:
              type: string
            occurred_at:
              type: string
              format: date-time
      example:
        event_id: "550e8400-e29b-41d4-a716-446655440007"
        event_type: "task.completed"
        occurred_at: "2024-01-01T18:00:00Z"
        source: "task-service"
        event_version: "1.0.0"
        task_id: "123e4567-e89b-12d3-a456-426614174003"
        agent_name: "ResearchAgent"
        result: { "summary": "Market is growing" }
        completion_time: "2024-01-01T18:00:00Z"
