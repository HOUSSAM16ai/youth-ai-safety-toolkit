# تقرير تشخيص احترافي: العنصر الأكثر ترشحًا للنقل التالي إلى خدمة مصغّرة

## 1) الملخص التنفيذي

بعد التشخيص البنيوي والتشغيلي للوضع الانتقالي الحالي، فإن **العنصر الأكثر ترشحًا للنقل الآن** هو:

> **منظومة Chat Orchestration/BFF (مسار محادثة العملاء داخل المونوليث)**
> 
> وتحديدًا: طبقة التنسيق في `app/services/chat` ونقطة الدخول `app/api/routers/customer_chat.py` مع تفكيك التبعية المباشرة على منطق التنسيق المحلي وتحويلها إلى استدعاء تعاقدي صريح للخدمة المنسّقة (`orchestrator_service`).

هذا القرار ليس انطباعيًا؛ بل قائم على فجوة واضحة بين الدستور المعماري (سلطة تنسيق واحدة) وبين الواقع الحالي (تنسيق مزدوج: جزء داخل المونوليث + جزء داخل خدمة المنسق).

---

## 2) سياق الحالة الانتقالية الحالية

### 2.1 ما الذي تم نقله بالفعل؟
النظام يحتوي فعليًا على خدمات مصغرة قائمة (Planning / Memory / User / Orchestrator / Observability) مع تشغيل عبر API Gateway، ما يعني أن الانتقال بدأ فعليًا وأن البنية التحتية للخدمات متاحة وجاهزة للتوسّع. 

### 2.2 ما الذي لا يزال داخل المونوليث؟
ما يزال **مسار محادثة العملاء** في المونوليث عبر `/api/chat/*`، مع WebSocket وتوجيه النوايا وربط مباشر بمكونات محلية. هذا يضع وظيفة عالية الحساسية وعالية التغيير في الطبقة القديمة بدل أن تكون خلف حدود خدمة واضحة.

---

## 3) الأدلة التشخيصية (Evidence)

### الدليل A: تضارب مباشر مع قرار معماري معتمد
ADR-001 يحسم أن `orchestrator_service` هو **المنسق الوحيد**، ويمنع المنطق التنسيقي المعقد داخل `app/services/chat`. 

### الدليل B: وجود تنسيق مزدوج فعليًا في التنفيذ
`ChatOrchestrator` داخل المونوليث ما يزال يقوم باكتشاف النية، إدارة الكاش، اختيار الاستراتيجيات، وتنفيذ مسارات محلية؛ وفي نفس الوقت يفوض بعض النوايا فقط إلى `orchestrator_client`. هذا يخلق **Partial Delegation Anti-Pattern** (تفويض جزئي يضاعف نقاط القرار).

### الدليل C: بقاء واجهة المحادثة في نواة المونوليث
`customer_chat` router ما يزال مسؤولًا عن مسار WebSocket وسلوك تدفق الاستجابة النهائي، ويتكامل مباشرة مع `ChatOrchestrator.dispatch` داخل نفس التطبيق.

### الدليل D: تشخيص هندسي سابق يؤكد انحراف سلطة التنسيق
تقرير `FULL_CODEBASE_MULTI_AGENT_DIAGNOSTIC` يحدد "Orchestration Drift" كأخطر خطر معماري بعيد المدى، مع تعدد المنسقات وتداخل صلاحيات القرار.

---

## 4) لماذا هذا العنصر هو "الأكثر ترشحًا" الآن؟

### 4.1 معيار الاختيار
تم تقييم المرشحين وفق خمسة معايير عملية:
1. **وضوح حدود المجال (Bounded Context Clarity)**
2. **قيمة تقليل المخاطر المعمارية فورًا**
3. **الاستفادة من البنية الجاهزة حاليًا**
4. **خفض الاقتران (Coupling Reduction) السريع**
5. **إمكانية تطبيق Strangler Fig تدريجيًا بلا Big Bang**

### 4.2 نتيجة التقييم
منظومة Chat Orchestration/BFF تتصدر لأن:
- لديها تأثير عابر للنظام (المستخدم النهائي + دورة الوكلاء + تدفق الأحداث).
- هي نقطة تداخل مباشرة مع مشكلة السلطة التنسيقية التي تم تشخيصها كخطر #1.
- توجد خدمة منسق بالفعل (جاهزة لاستقبال النقل التدريجي)، مما يقلل كلفة البدء.

---

## 5) التصميم المستهدف للنقل

### الهدف المعماري
تحويل `customer_chat` في المونوليث إلى **BFF رقيق (Thin BFF)**:
- يستقبل فقط اتصال المستخدم (HTTP/WebSocket)
- يطبق authN/authZ وحدود النقل
- يمرر الأوامر إلى `orchestrator_service` بعقد واضح
- يبث الأحداث كما هي (Command -> Event)

### ما الذي يجب أن يغادر المونوليث؟
- اكتشاف النوايا المحلي
- اختيار المعالجات المحلية
- أي منطق قرار Workflow
- أي fallback سلوكي غير موحّد

### ما الذي يبقى مؤقتًا؟
- طبقة العرض والنقل (WebSocket gateway behavior)
- سياسات الحماية الطرفية القريبة من واجهة العميل (Rate limit / Auth extraction)

---

## 6) خطة التنفيذ الاحترافية المقترحة (مرحلية)

### المرحلة 0: تثبيت العقود (Contract Freeze)
- تثبيت OpenAPI/Streaming contract لمسار chat داخل `orchestrator_service`.
- تعريف Event Schema موحّد للأحداث المرسلة للواجهة.

### المرحلة 1: Shadow Mode
- تنفيذ مسار مزدوج غير مرئي: 
  - المسار الحالي ينتج الاستجابة الفعلية.
  - orchestrator_service ينفذ نفس الطلب في الخلفية.
- قياس فروق السلوك (Latency, Completeness, Safety blocks).

### المرحلة 2: Progressive Cutover
- تحويل intents عالية القيمة أولًا (مثل mission/deep-analysis) بنسبة مرور تدريجية.
- استخدام feature flags وcanary rollout.

### المرحلة 3: Remove Local Decision Logic
- إزالة/تعطيل منطق استراتيجية النوايا داخل `app/services/chat/orchestrator.py`.
- إبقاء الـ BFF فقط.

### المرحلة 4: Hardening
- SLOs واضحة: P95 latency، error budget، completion rate.
- ربط كل الطلبات بـ Correlation-ID end-to-end.

---

## 7) المخاطر المتوقعة وخطة المعالجة

1. **زيادة الكمون (Latency)**
   - المعالجة: streaming مبكر، timeouts دقيقة، circuit breaker لكل نداء.

2. **انحراف سلوكي أثناء الانتقال**
   - المعالجة: Shadow parity + golden datasets + contract tests سلوكية.

3. **ازدواجية مؤقتة في المسؤوليات**
   - المعالجة: تاريخ إيقاف واضح (sunset date) لمنطق المونوليث المحلي.

4. **صعوبة تتبع الأعطال عبر الحدود**
   - المعالجة: OpenTelemetry + Correlation-ID إلزامي في كل hop.

---

## 8) مؤشرات النجاح (KPIs) بعد النقل

- انخفاض واضح في تعدد نقاط القرار orchestration داخل المونوليث.
- 100% من chat intents تمر عبر عقد orchestrator_service (باستثناء fallback اضطراري محدود بزمن).
- انخفاض regressions المرتبطة بـ intent routing.
- تحسن MTTR بسبب وضوح ownership وحدود الفشل.

---

## 9) القرار النهائي

**القرار الموصى به:**

> ابدأ بالنقل التالي من المونوليث إلى microservice عبر **استخراج Chat Orchestration/BFF** وربطه بالكامل بـ `orchestrator_service` كسلطة وحيدة للقرار.

هذا الخيار يحقق أكبر خفض فوري للمخاطر المعمارية، ويعالج أخطر خلل مشخص (Orchestration Drift)، ويستثمر البنية المصغرة الموجودة بالفعل بدل توسيع المنطقة الرمادية الهجينة.

---

## 10) ما لم يتم فعله في هذا الطلب

- لم يتم تعديل أي كود تنفيذي.
- لم يتم تغيير أي Endpoint أو سلوك Runtime.
- هذا المستند تقرير تشخيصي وتنفيذي فقط لاتخاذ القرار المعماري.
