# خارطة طريق عميقة: الانتقال الآمن من المونوليث إلى خدمات مصغّرة متطورة (بدون كسر النظام)

## 1) الهدف الأعلى
هذه الخارطة تضمن **تفكيكًا تدريجيًا وآمنًا** للنظام المونوليتي إلى معمارية خدمات مصغّرة API-First، مع الحفاظ على:
- استمرارية الخدمة (Zero/Minimal Downtime).
- التوافق الخلفي (Backward Compatibility) أثناء الانتقال.
- عدم كسر الوظائف الحالية عبر آليات تحقق متعددة المستويات.

> المبدأ الحاكم: **لا يوجد Big Bang Rewrite**. كل خطوة صغيرة، قابلة للرجوع (Reversible)، ومحمية بقياسات صحة قبل/أثناء/بعد التنفيذ.

---

## 2) مبادئ عدم الكسر (Non-Breaking Guardrails)

1. **قاعدة التوافق أولًا**
   - لا يتم حذف أي API قديم قبل مرور دورة إهمال كاملة (Deprecation Cycle).
   - نسخة API جديدة تعمل جنبًا إلى جنب مع القديمة (`v1` + `v2`) إلى أن يهاجر 100% من المستهلكين.

2. **قاعدة التفعيل التدريجي**
   - كل مسار جديد خلف Feature Flags.
   - تفعيل Canary تدريجي (1% → 5% → 25% → 50% → 100%).

3. **قاعدة الفصل دون نقل المخاطر**
   - في كل مرحلة: فصل المسؤولية أولًا داخل المونوليث (Modular Monolith) قبل استخراجها كخدمة.
   - يمنع استخراج سياق أعمال غير مستقر أو غير مغطى اختباريًا.

4. **قاعدة الرجوع الفوري (Instant Rollback)**
   - كل نشر يجب أن يملك خطة رجوع أقل من 10 دقائق.
   - دعم Dual-Write أو Outbox بنمط قابل للتعطيل الفوري.

5. **قاعدة القياس قبل القرار**
   - لا اعتماد إنتاجي لأي خدمة جديدة بدون SLO/SLI واضحة، وتتبع موزّع، وإنذارات فعّالة.

---

## 3) نموذج الهجرة المعتمد

### النمط الرئيسي: Strangler Fig + Anti-Corruption Layer
- **Strangler Fig**: خنق المونوليث تدريجيًا بتحويل مسارات محددة إلى خدمات خارجية.
- **Anti-Corruption Layer (ACL)**: طبقة ترجمة تمنع تسرب نماذج المونوليث الداخلية إلى الخدمة الجديدة.

### لماذا هذا النموذج؟
- يسمح بالترحيل التدريجي منخفض المخاطر.
- يضمن استقلالية السياقات (Bounded Contexts).
- يحافظ على استقرار واجهات المستهلكين الحاليين.

---

## 4) مراحل التنفيذ العميقة

## المرحلة 0: التقييم والخط الأساسي (2–4 أسابيع)
**الهدف:** معرفة الواقع الحالي بدقة قبل أي فصل.

### المخرجات المطلوبة
- خريطة تدفق الطلبات الحرجة End-to-End.
- خريطة الاعتماديات (Code + Runtime + DB).
- مصفوفة المخاطر (Availability, Security, Data Integrity).
- Baseline أداء: P95/P99، نسبة الأخطاء، زمن استرجاع الخدمة.

### البوابات (Gates)
- Gate 0.1: توثيق 100% للواجهات العامة المستخدمة فعليًا.
- Gate 0.2: تعريف رحلة المستخدم الحرجة (Golden Paths) واختباراتها الآلية.

---

## المرحلة 1: تحصين المونوليث داخليًا (4–8 أسابيع)
**الهدف:** تحويل المونوليث إلى Modular Monolith نظيف الحدود.

### الأنشطة
- تعريف Bounded Contexts واضحة (هوية، فواتير، مهام، إشعارات، ذكاء...).
- منع الاستدعاءات العرضية بين الوحدات إلا عبر واجهات معلنة.
- نقل منطق الأعمال من الـControllers إلى Application Services.
- عزل الوصول للبيانات عبر Repositories/Ports.

### البوابات
- Gate 1.1: عدم وجود استدعاء مباشر لقاعدة بيانات سياق آخر.
- Gate 1.2: اختبارات Contract داخلية بين الوحدات.
- Gate 1.3: تغطية سلوك المسارات الحرجة لا تقل عن 90%.

---

## المرحلة 2: منصة التشغيل المشتركة (3–6 أسابيع بالتوازي)
**الهدف:** تجهيز البنية التشغيلية قبل أول Service Extraction.

### الأنشطة
- توحيد بوابة دخول API Gateway.
- مركزية الهوية الأمنية (OAuth2/OIDC، JWT، mTLS داخليًا عند الحاجة).
- Observability Stack: Logs + Metrics + Traces + Correlation IDs.
- Message Broker قياسي للأحداث غير المتزامنة.
- منصة CI/CD مع سياسات جودة موحدة (Security Scan, SBOM, Contract Checks).

### البوابات
- Gate 2.1: كل طلب يحمل Trace ID حتى قاعدة البيانات.
- Gate 2.2: فشل خدمة جديدة لا يعطل المونوليث (Circuit Breakers + Timeouts).

---

## المرحلة 3: أول استخراج منخفض المخاطر (4–6 أسابيع لكل خدمة)
**الهدف:** إثبات النموذج على نطاق ضيق قبل الخدمات الحرجة.

### اختيار الخدمة الأولى
- معايير الاختيار:
  - اقتران منخفض.
  - معاملات بسيطة نسبيًا.
  - تأثير محدود إذا فشلت.
- أمثلة مناسبة: الإشعارات، إدارة القوالب، التفضيلات.

### أسلوب التنفيذ
1. بناء واجهة API مستقلة للخدمة الجديدة.
2. إضافة ACL داخل المونوليث.
3. تشغيل Shadow Traffic للمقارنة دون تأثير المستخدم.
4. تفعيل Canary تدريجي.
5. اعتماد الخدمة ثم إزالة المسار القديم تدريجيًا.

### البوابات
- Gate 3.1: تطابق المخرجات بين القديم والجديد على عينة كبيرة.
- Gate 3.2: عدم تدهور SLO لأكثر من 5% في فترة التجربة.

---

## المرحلة 4: استخراج الخدمات الأساسية تدريجيًا (3–9 أشهر)
**الهدف:** تفكيك المجالات الأساسية على موجات، لا دفعة واحدة.

### ترتيب موجات مقترح
1. **خدمات داعمة غير حرجة** (Notifications, Audit, Media Metadata).
2. **خدمات عمليات متوسطة التعقيد** (Task orchestration, Reporting).
3. **الخدمات المالية/الهوية/الحرجة** في النهاية فقط بعد نضج المنصة.

### مبادئ البيانات أثناء الاستخراج
- Database per Service من أول يوم.
- منع Cross-Service Joins تمامًا.
- استخدام Outbox + CDC أو Domain Events للمزامنة.
- اعتماد Saga (Choreography/Orchestration) للمعاملات الموزعة.

### البوابات
- Gate 4.1: لا توجد تبعيات قاعدة بيانات مشتركة بين الخدمات المستخرجة.
- Gate 4.2: كل خدمة تملك Runbook، SLO، وحدود موارد واضحة.

---

## المرحلة 5: إيقاف أجزاء المونوليث المتبقية (2–4 أشهر)
**الهدف:** تقليص المونوليث إلى بقايا انتقالية ثم إيقافها.

### الأنشطة
- تحليل استخدام API القديم فعليًا (Traffic + Consumers).
- برنامج إيقاف تدريجي مع إعلانات إهمال رسمية.
- تعطيل Dual-Write نهائيًا بعد تأكيد سلامة البيانات.
- إزالة ACLs غير المطلوبة.

### البوابات
- Gate 5.1: صفر استدعاءات للمسارات المتوقفة خلال فترة أمان.
- Gate 5.2: تدقيق تكاملي للبيانات بين الخدمات بنسبة تطابق متفق عليها.

---

## المرحلة 6: التحسين المتقدم (مستمر)
**الهدف:** الانتقال من "يعمل" إلى "متفوق".

### المسارات
- Autoscaling ذكي لكل خدمة حسب SLO وليس فقط CPU.
- تحسين الكلفة (FinOps) لكل خدمة.
- GameDays دورية لفشل الشبكات/الاعتماديات.
- Chaos Engineering مضبوط على الخدمات الحرجة.

---

## 5) استراتيجية البيانات بدون كسر

1. **نقل المخطط على مراحل**: Expand → Migrate → Contract.
2. **الكتابة المزدوجة المشروطة**: Dual-Write خلف Flag ومع مراقبة تناسق.
3. **القراءة الانتقالية**: Read-Through Adapter حتى اكتمال الترحيل.
4. **تدقيق التناسق**: وظائف تحقق يومية + تنبيهات انحراف.
5. **خطة تعافٍ**: نقطة استرجاع واضحة (PITR) لكل خدمة.

---

## 6) استراتيجية الاختبارات والضمان

- اختبارات عقود API (Consumer-Driven Contracts).
- اختبارات E2E للمسارات الذهبية قبل وبعد كل موجة.
- اختبارات تحميل ومتانة (Load/Stress/Soak).
- اختبارات فشل جزئي (Dependency Down Scenarios).
- فحوص أمنية تلقائية (SAST/DAST/Secrets/IaC).

> معيار المرور: لا نشر إنتاجي إذا فشل أي اختبار عقد أو سيناريو ذهبي.

---

## 7) الحوكمة التشغيلية والتنظيمية

- **فريق منصة مركزي**: يوفر البنية، المراقبة، التمكين.
- **فرق خدمات مستقلة**: تملك الخدمة كاملة (Build/Run/Support).
- **مجلس معمارية أسبوعي**: مراجعة الحدود، الديون التقنية، قرارات ADR.
- **سياسة "تبعية صريحة"**: أي اعتماد جديد بين خدمتين يحتاج عقدًا موثقًا.

---

## 8) مؤشرات نجاح (KPIs) لكل ربع

- نسبة المسارات المستخرجة من المونوليث.
- معدل فشل النشر (Change Failure Rate).
- زمن الاسترجاع (MTTR).
- التزام SLO لكل خدمة.
- نسبة الحوادث الناتجة عن تكاملات بين الخدمات.
- كلفة التشغيل لكل سياق أعمال.

---

## 9) الجدول الزمني المقترح (مرن حسب الواقع)

- **Q1**: مرحلتا 0 و1 + تأسيس بوادر المرحلة 2.
- **Q2**: إكمال المرحلة 2 + أول خدمة مستخرجة (المرحلة 3).
- **Q3–Q4**: موجات المرحلة 4 للخدمات المتوسطة.
- **Q5+**: الخدمات الحرجة + المرحلة 5 ثم تحسينات المرحلة 6.

---

## 10) قائمة "ممنوعات" تمنع الكسر

- ممنوع استخراج خدمة بدون حدود مجال واضحة.
- ممنوع مشاركة قاعدة بيانات بين خدمتين.
- ممنوع استدعاء متسلسل عميق (Service A→B→C→D) في المسارات الحرجة.
- ممنوع حذف API قبل قياس استهلاكه الحقيقي وإتمام دورة الإهمال.
- ممنوع إطلاق إنتاجي بلا Traceability كاملة.

---

## 11) خطة تنفيذ فورية (أول 30 يوم)

1. تشكيل فريق هجرة مصغّر (Platform + Domain Leads + SRE).
2. إعداد Service Catalog أولي وحدود السياقات.
3. تعريف Golden Journeys واختباراتها الآلية.
4. تفعيل Correlation IDs وتتبع موزّع أساسي.
5. اختيار أول خدمة استخراج منخفضة المخاطر وتحديد عقد API لها.
6. تجهيز خطة Canary + Rollback مفصلة قبل أي نقل فعلي.

---

## الخلاصة التنفيذية
الانتقال الآمن لا يعتمد على "سرعة التفكيك" بل على **جودة البوابات** بين المراحل. إذا تحققت البوابات، يمكن الانتقال بخطى سريعة دون كسر. إذا لم تتحقق، التوقف أفضل من التسرع. بهذه الخارطة، يتحول النظام من مونوليث خطير إلى منظومة خدمات مصغّرة عالية الاعتمادية وقابلة للتوسع المستقل، مع مخاطرة تشغيلية مضبوطة.
